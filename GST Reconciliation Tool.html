<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Purchase vs GSTR-2B Reconciliation</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Google Fonts for clean typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary: #125784;
            --primary-light: #f3f7fb;
            --accent: #1abc9c;
            --error: #d0001c;
            --warning: #ffe066;
            --success: #198754;
            --bg: #f7fbfc;
            --card: #fff;
            --tab-active: #fff;
            --tab-inactive: #e9eef3;
            --border: #c6d6e6;
            --shadow: 0 4px 32px rgba(18,87,132,0.08);
            --input-bg: #f7fafd;
        }

        body {
            font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
            background: var(--bg);
            min-height: 100vh;
            margin: 0;
            color: #213245;
        }

        .container {
            width: 95%;
			max-width: none;
			margin: 0;
			padding: 32px 3vw 24px 3vw; /* Responsive left/right padding */
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1.5px solid var(--border);
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 18px;
            color: var(--primary);
            letter-spacing: 1px;
        }

        .section {
            margin-bottom: 32px;
        }
        .section-title {
            font-weight: 600;
            color: var(--primary);
            font-size: 1.2rem;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #34648a;
            font-size: 1rem;
        }

        .row-flex {
            display: flex;
            flex-wrap: wrap;
            gap: 48px;
        }

        .col {
           flex: 1 1 0;      /* min/max width */
			min-width: 180px;
			max-width: 300px;
        }
		
		.col-half {
           flex: 1 1 0;      /* min/max width */
			min-width: 475px;
			max-width: 475 px;
        }
		
		/* Make the file input span full width (across 3 cols) */
		.col-full {
			flex: 0 0 100%;
			max-width: 1000px;
		}

        input[type="text"],
        input[type="month"],
        select,
        input[type="file"] {
            padding: 6px 10px;
            width: 100%;
            font-size: 1.04rem;
            border-radius: 7px;
            border: 1.5px solid var(--border);
            background: var(--input-bg);
            font-family: 'Inter', Arial, sans-serif;
            transition: border 0.2s;
            margin-bottom: 0;
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            background: #fff;
        }

        .button {
            background: linear-gradient(90deg, var(--primary) 60%, var(--accent) 100%);
            color: #fff;
            padding: 13px 36px;
            font-size: 1.12em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            letter-spacing: 1px;
            font-family: inherit;
            cursor: pointer;
            margin-right: 14px;
            box-shadow: 0 2px 10px rgba(18,87,132,0.07);
            transition: background 0.15s, box-shadow 0.15s;
        }
        .button:disabled {
            background: #d3e2ee !important;
            color: #8598aa;
            cursor: not-allowed;
            box-shadow: none;
        }
        .button#downloadBtn {
            background: linear-gradient(90deg, var(--success) 70%, #1abc9c 100%);
        }
        .download-link {
            color: var(--primary);
            font-weight: 600;
            text-decoration: underline;
            cursor: pointer;
            font-size: 1.06em;
            margin-right: 16px;
        }
        .download-link:hover {
            color: var(--accent);
        }
        .note {
            background: #f7f7d9;
            border-left: 6px solid var(--warning);
            padding: 14px 30px;
            margin-top: 14px;
            margin-bottom: 18px;
            font-size: 1.07em;
            color: #756212;
            border-radius: 6px;
        }
        .footer {
            margin-top: 48px;
            text-align: center;
            font-size: 1.08em;
            color: #5d5d5d;
        }
        .footer b { color: var(--primary); }
        .tabs {
            margin-top: 38px;
            display: flex;
            gap: 0.5px;
            border-bottom: 2.5px solid var(--border);
            background: var(--border);
            border-radius: 9px 9px 0 0;
            overflow-x: auto;
        }
        .tab {
            padding: 14px 38px 13px 38px;
            cursor: pointer;
            background: var(--tab-inactive);
            color: #406e95;
            font-weight: 600;
            font-size: 1.06em;
            border-top-left-radius: 9px;
            border-top-right-radius: 9px;
            border: 1.5px solid var(--border);
            border-bottom: none;
            margin-bottom: -2.5px;
            transition: background 0.14s, color 0.14s;
        }
        .tab.active {
            background: var(--tab-active);
            color: var(--accent);
            border-bottom: 2.5px solid #fff;
            box-shadow: 0px -2px 14px 0 rgba(18,87,132,0.07);
            z-index: 2;
            position: relative;
        }
        .tab-content {
            display: none;
            background: var(--tab-active);
            border: 1.5px solid var(--border);
            border-top: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            padding: 30px 12px 26px 12px;
            min-height: 220px;
            animation: fadein 0.23s;
        }
        .tab-content.active { display: block; }

        @keyframes fadein {
            from { opacity: 0; transform: translateY(20px);}
            to { opacity: 1; transform: none;}
        }

        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            font-size: 1.05em;
            margin-top: 8px;
            background: #fff;
            border-radius: 9px;
            overflow: hidden;
            box-shadow: 0 1px 5px rgba(18,87,132,0.04);
        }
        th {
            background: linear-gradient(90deg, #e6f1fa 70%, #d6ebf8 100%);
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            font-size: 1.08em;
            border-bottom: 2.5px solid var(--border);
            border-top: none;
            padding: 12px 7px;
            white-space: pre-line;
            word-break: break-word;
        }
        td {
            padding: 12px 7px;
            border-bottom: 1.5px solid #e7e7e7;
            text-align: right;
            font-family: 'Inter', Arial, sans-serif;
            background: #fcfcff;
            font-size: 1.01em;
        }
        td.text, th.text { text-align: left !important; }
        .red-bold { color: var(--error) !important; font-weight: 700 !important;}
        .right { text-align: right !important;}
        .wrap { white-space: pre-line; word-break: break-word;}
        tr:last-child td { border-bottom: none; }
        tr.totals-row td {
            font-weight: bold;
            background: #e8f6f3;
            color: var(--primary);
            font-size: 1.08em;
        }
        .summary-table thead tr {
            background: linear-gradient(90deg, #125784 80%, #178fa0 100%);
        }
        .summary-table th {
            color: #fff;
            border-bottom: 2.5px solid #178fa0;
            background: none;
        }
        .summary-table tr.section-header td {
            background: #125784;
            color: #fff;
            font-weight: 700;
            text-align: center;
            font-size: 1.11em;
        }
        .summary-table tr.totals-row td {
            background: #178fa0;
            color: #fff;
        }
        @media (max-width: 900px) {
            .container {padding: 10px;}
            .row-flex {flex-direction: column; gap: 0;}
            h1 {font-size: 2em;}
            .tab {font-size: 1em; padding: 10px 10px;}
            .section {padding: 0;}
        }
        @media (max-width: 600px) {
            .container {padding: 2px;}
            .tab {padding: 9px 6px;}
        }
		/* Make table columns compact and prevent wrapping */
		th, td {
		  max-width: 300px;
		  min-width: 60px;
		  width: 110px;
		  overflow: hidden;
		  text-overflow: ellipsis;
		  white-space: nowrap //!important;
		  word-break: normal //!important;
		}
		
		}		
    </style>
</head>
<body>
<div class="container">
    <h1>GSTR-2B Reconciliation Tool</h1>
    <div class="section" style="margin-bottom:22px;">
		<!-- First Row -->
		<div class="row-flex">
			<div class="col col-half">
				<label for="taxpayerName">Name of Taxpayer<span style="color:red">*</span></label>
				<input id="taxpayerName" type="text" placeholder="Enter taxpayer name" required>
			</div>
			<div class="col col-half">
				<label for="gstin">GSTIN <span style="color:red">*</span></label>
				<input id="gstin" type="text" placeholder="Enter GSTIN" pattern="[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}" required>
			</div>
		</div>
		<!-- Second Row -->
		<div class="row-flex">
			<div class="col">
				<label for="rounding">Rounding Off</label>
				<select id="rounding">
					<option value="0.00">0.00</option>
					<option value="1.00" selected>1.00</option>
					<option value="2.00">2.00</option>
					<option value="5.00">5.00</option>
					<option value="10.00">10.00</option>
				</select>
			</div>
			<div class="col">
				<label for="periodFrom">Period From (Month-Year)</label>
				<input id="periodFrom" type="month">
			</div>
			<div class="col">
				<label for="periodTo">Period To (Month-Year)</label>
				<input id="periodTo" type="month">
			</div>
		</div>
	</div>
    <div class="section">
        <span class="section-title">Step 1: Download and Fill Data Templates</span>
        <span class="download-link" onclick="downloadTemplates()">Download Excel Templates</span>
        <div class="note">
            <ul style="margin:0 0 0 18px;padding-left:0.9em">
                <li>Download the Excel Template and fill your <b>"Books"</b> and <b>"Portal (GSTR-2B)" </b>data as per Given Format. (Mandatory Columns in Template are colored <b><span style="color:#FF0000">RED</span></b> and <b>BOLD</b>)</li>
                <li>Import the <b>filled Excel file</b> using the button below. The Excel file must contain two separate sheets: <span style="color:#178fa0">"Books"</span> for purchases, and <span style="color:#178fa0">"Portal"</span> for GSTR-2B.</li>
            </ul>
        </div>
        <div class="row-flex">
            <div class="col col-full">
                <label for="importFile"><b>Step 2: Import Excel File (Books & Portal)</b></label>
                <input type="file" accept=".xls,.xlsx" id="importFile">
            </div>
        </div>
        <div class="note" style="margin-top: 8px;">
            <b>Note:</b> Upload a single Excel file containing both required sheets (<b>Books</b> and <b>Portal</b>).
        </div>
    </div>
    <div class="section" style="margin-bottom:14px;">
        <button class="button" id="reconcileBtn" onclick="reconcile()" disabled>Reconcile</button>
        <button class="button" id="downloadBtn" onclick="downloadOutput()" style="display:none">Download Reconciliation Report (Excel)</button>
    </div>
    <div id="tabsContainer" style="display:none">
        <div class="tabs" id="tabs"></div>
        <div id="tabContents"></div>
    </div>
    <div class="footer" style="margin-top: 30px; text-align: center; font-size: 1.09em; color: #5d5d5d;">
    <div style="display: inline-block; text-align: left; background: #f9fafc; border-radius: 8px; padding: 18px 26px; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(21,95,160,0.06); border: 1.5px solid #e3eef7;">
        <span style="display: block; color: #26496b; font-size: 1.00em; margin-top: 8px; text-align: center; margin-bottom: 12px;"">
            Designed & Developed by <b>M/s HNVB & ASSOCIATES, Chartered Accountants.</b> for GST Reconciliation purposes.
			
        </span>
		<span style="font-weight: 600; color: #155fa0; font-size: 1.09em; display: block; margin-bottom: 7px;">Instructions for Use:</span>
		<ol style="margin: 0 0 8px 22px; padding: 0; color: #26496b; font-size: 1em;">
            <li>Enter the taxpayer’s details, including the <b>Name of Taxpayer</b>, <b>GSTIN</b>, and the relevant period.</li>
            <li>Download and complete the provided Excel template, ensuring that both the <b>“Books”</b> and <b>“Portal”</b> data sheets are filled.</li>
            <li>Import the completed Excel template (containing both required sheets) into the system.</li>
            <li>Click the <b>Reconcile</b> button to initiate the reconciliation process.</li>
            <li>Review the reconciliation results displayed in the respective tabs.</li>
            <li>Download the professionally formatted Excel output for your records.</li>
        </ol>
		</div>
	</div>
</div>
	<span id="taxpayerName"></span>
	<span id="gstin"></span>
<script>
// -- Existing JavaScript code goes here, unchanged --
// (Paste your full script here, including all utility functions, Excel logic, etc.)

/* --- Utility functions, template download, import, parse, reconcile, tab logic as before --- */
const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
function formatIndianNumber(num){if(isNaN(num)||num===null||num==="")return"";num=Number(num);let[int,dec]=num.toFixed(2).split(".");let lastThree=int.substring(int.length-3);let otherNumbers=int.substring(0,int.length-3);if(otherNumbers!=='')lastThree=','+lastThree;let res=otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g,",")+lastThree;return dec?res+"."+dec:res;}
function formatDate(dt){if(!dt)return"";if(typeof dt==="number")return excelDateToJSDate(dt);let s=String(dt).trim();let m=s.match(/^(\d{1,2})[\/\-.](\d{1,2})[\/\-.](\d{4})$/);if(m)return`${m[1].padStart(2,"0")}-${monthNames[parseInt(m[2],10)-1]}-${m[3]}`;m=s.match(/^(\d{4})[\/\-.](\d{1,2})[\/\-.](\d{1,2})$/);if(m)return`${m[3].padStart(2,"0")}-${monthNames[parseInt(m[2],10)-1]}-${m[1]}`;let d=new Date(s);if(!isNaN(d))return`${String(d.getDate()).padStart(2,"0")}-${monthNames[d.getMonth()]}-${d.getFullYear()}`;return"";}
 // Validate GSTIN format
        function validateGSTIN(gstin) {
            const gstinRegex = /^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$/;
            return gstinRegex.test(gstin);
        }
function excelDateToJSDate(serial){let utc_days=Math.floor(serial-25569);let utc_value=utc_days*86400;let date_info=new Date(utc_value*1000);return`${String(date_info.getDate()).padStart(2,"0")}-${monthNames[date_info.getMonth()]}-${date_info.getFullYear()}`;}
function floatEqual(a,b,round){return Math.abs(Number(a)-Number(b))<=round;}
function parseNumber(val){if(val===""||val===null||val===undefined)return 0;return Number(String(val).replace(/,/g,""))||0;}
function normStr(s){return String(s||"").toUpperCase().replace(/\s+/g,'');}
async function downloadTemplates(){
    let taxpayerName = document.getElementById("taxpayerName").value || "ABC Pvt Ltd";
    let GSTIN = document.getElementById("gstin").value || "24AAACA0010A1Z5";
	let booksHeaders=["Date","Name of Supplier","GSTIN","Vch_Type","Vch_No.","Invoice_No.","Invoice_Date","Taxable_Amount","IGST","CGST","SGST","CESS","Total_Tax_Amount"];
    let booksSample=[
					 ["01-Apr-2025","XYZ Pvt Ltd","24AAACX0001S1Z1","Purchase","1","INV123","01/05/2024",10000,"",250,250,"",500],
					 ["10-Apr-2025","PQR Associates","27AAAFP1111Q1ZH","Purchase","2","5/2025-26","13/05/2025",20000,3600,"","","",3600]
					];
    let portalHeaders=["GSTIN","Trade_Name","Invoice_No.","Invoice_Type","Invoice_Date","Invoice_Value","Place_of_supply","Supply_Attract_Reverse_Charge","Taxable_Amount","IGST","CGST","SGST","CESS","GSTR-1/_IFF/_GSTR-5_Period","GSTR-1/_IFF/_GSTR-5_Filing_Date","ITC_Availability","Reason","Applicable_%_of_Tax_Rate","Source","IRN","IRN_Date"];
    let portalSample=[
					  ["24AAACX0001S1Z1","XYZ Pvt Ltd","INV123","Regular","01-Apr-2025",10500,"Gujarat","No",10000,0,250,250,0,"Apr-2025","10-May-2025","Available","",18,"E-Invoice","",""],
					  ["27AAAFP1111Q1ZH","PQR Associates","5/2025-26","Regular","10-Apr-2025",23600,"Gujarat","No",20000,3600,0,0,0,"Apr-2025","07-May-2025","Available","",18,"","",""]
					 ];
    let wb=new ExcelJS.Workbook();
    let wsBooks = wb.addWorksheet("Books");
	wsBooks.addRow(["Name of Taxpayer: ","", taxpayerName]);
    wsBooks.addRow(["GSTIN : ","",	GSTIN]);
	wsBooks.addRow([]);
	wsBooks.addRow(booksHeaders);
	booksSample.forEach(row => wsBooks.addRow(row)); // Add all sample rows
	
	// Format: Bold headers & taxpayer info
    [1,2,4].forEach(rowIdx => {
        wsBooks.getRow(rowIdx).font = { bold: true, size: 12 };
    });
	
	let wsPortal = wb.addWorksheet("Portal");
	
	wsPortal.addRow(["Name of Taxpayer:", "",taxpayerName]);
    wsPortal.addRow(["GSTIN: ", "",GSTIN]);
    wsPortal.addRow([]);
	wsPortal.addRow(portalHeaders);
	portalSample.forEach(row => wsPortal.addRow(row)); // Add all sample rows
	[1,2,4].forEach(rowIdx => {
        wsPortal.getRow(rowIdx).font = { bold: true, size: 12 };
    });
	
	 // Apply date format to entire columns (not just sample row)
	wsBooks.getColumn(1).numFmt = 'DD-MMM-YYYY';   // Date
	wsBooks.getColumn(7).numFmt = 'DD-MMM-YYYY';   // Invoice_Date

	wsPortal.getColumn(5).numFmt = 'DD-MMM-YYYY';   // Invoice_Date
	wsPortal.getColumn(15).numFmt = 'DD-MMM-YYYY';  // GSTR-1/_IFF/_GSTR-5_Filing_Date
	wsPortal.getColumn(21).numFmt = 'DD-MMM-YYYY';  // IRN_Date
	
	// --- Borders and Header Formatting Helper ---
    function formatTable(ws, headerRowIdx, nRows, nCols, mandatoryHeaders=[]) {
        // Format header row
        const headerRow = ws.getRow(headerRowIdx);
        headerRow.font = { bold: true };
        headerRow.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true};
        headerRow.eachCell((cell, colNumber) => {
            cell.border = {
                top: {style:'thin'}, left: {style:'thin'}, bottom: {style:'thin'}, right: {style:'thin'}
		    };
		    // Red and bold for mandatory fields
            if (mandatoryHeaders.includes(cell.value)) {
                cell.font = { color: { argb: "FFFF0000" }, bold: true };
            } else {
                cell.font = { bold: true };
            }
        });

        // Format all data cells in table
        for(let r=headerRowIdx+1; r<=headerRowIdx+nRows; ++r) {
            let row = ws.getRow(r);
            for(let c=1; c<=nCols; ++c) {
                let cell = row.getCell(c);
                cell.border = {
                     left: {style:'thin'}, right: {style:'thin'}
                };
                
            }
        }
    }

  // --- Apply formatting ---
    formatTable(wsBooks, 4, 100, booksHeaders.length, ["GSTIN", "Invoice_No.", "Invoice_Date", "Taxable_Amount", "IGST", "CGST", "SGST"]);
    formatTable(wsPortal, 4, 100, portalHeaders.length, ["GSTIN", "Invoice_No.", "Invoice_Date", "Taxable_Amount", "IGST", "CGST", "SGST"]);
	
	// Mandatory fields
	const mandatoryHeaders = ["GSTIN", "Invoice_No.", "Invoice_Date", "Taxable_Amount", "IGST", "CGST", "SGST"];

	const headerRowIndex = 4; // since data starts at Row 5

	// Apply header formatting for both sheets
	[wsBooks, wsPortal].forEach(ws => {
		const headerRow = ws.getRow(headerRowIndex);
		headerRow.eachCell((cell, colNumber) => {
			if (mandatoryHeaders.includes(cell.value)) {
				cell.font = { color: { argb: "FFFF0000" }, bold: true }; // red, bold
			} else {
				cell.font = { bold: true };
			}
			cell.alignment = { wrapText: true, vertical: 'middle', horizontal: 'center' }; // More header styling
		});
	});
	
	// Autosize columns for both sheets
    [wsBooks, wsPortal].forEach(ws => {
        ws.columns.forEach(col => {
            let maxLen = 6
            col.eachCell({ includeEmpty: true }, cell => {
                maxLen = Math.max(maxLen, (cell.value ? cell.value.toString().length : 0));
				cell.alignment = Object.assign({}, cell.alignment, { wrapText: true });
            });
			col.width = maxLen + 2;
        });
    });
	
    const buf=await wb.xlsx.writeBuffer();
    saveAs(new Blob([buf]),"GST_Reconciliation_Template.xlsx");
}
// Returns the first error as a string, or null if all rows are valid
// REQUIRED FIELDS VALIDATION WITH UI ERROR DISPLAY

function validateRowsAllErrors(data, sheetName) {
    const errors = [];
    for (let i = 0; i < data.length; i++) {
        const row = data[i];
        // 1. Check GSTIN, Invoice_No., Invoice_Date, Taxable_Amount
        const mustHave = ["GSTIN", "Invoice_No.", "Invoice_Date", "Taxable_Amount"];
		const allBlank = mustHave.every(field => !row[field] || row[field].toString().trim() === "");
        if (allBlank) continue;
        for (const field of mustHave) {
            if (!row[field] || row[field].toString().trim() === "") {
                errors.push(`Sheet "${sheetName}", row ${i + 5}: "${field}" is required.`);
            }
        }
        // 2. IGST or (CGST and SGST) logic
        const igst = row["IGST"] && row["IGST"].toString().trim() !== "";
        const cgst = row["CGST"] && row["CGST"].toString().trim() !== "";
        const sgst = row["SGST"] && row["SGST"].toString().trim() !== "";
        if (!(igst || (cgst && sgst))) {
            errors.push(`Sheet "${sheetName}", row ${i + 5}: Either "IGST" or both "CGST" and "SGST" must be filled.`);
        }
    }
    return errors;
}

// Use after extracting sheets, before setting booksData/portalData
async function handleSingleFileUpload(e) {
    // Always clear data and ready state at the start
    booksData = [];
    portalData = [];
    excelLoaded = false;
    document.getElementById('reconcileBtn').disabled = true;
	
	
	
	const file = e.target.files[0];
    if (!file) return;
    const { books, portal, workbook} = await extractSheetsFromFile(file);

    // Validate both sheets and collect all errors
    let errors = [];
    errors = errors.concat(validateRowsAllErrors(books, "Books"));
    errors = errors.concat(validateRowsAllErrors(portal, "Portal"));

    if (errors.length > 0) {
        // Display all errors at once in a single alert
        alert("Please fix the following errors:\n\n" + errors.join('\n'));
        // At the end, always reset the file input
		e.target.value = '';
		// Clear name and GSTIN fields
		document.getElementById("taxpayerName").value = "";
		document.getElementById("gstin").value = "";
		return;
    }

// === Autofill Taxpayer Name and GSTIN (do this only after validation succeeds) ===
    console.log("=== Autofill block reached ===");
if (workbook) {
    const wsBooks = workbook.getWorksheet('Books');
    console.log('wsBooks:', wsBooks);
    if (wsBooks) {
        const taxpayerName = wsBooks.getRow(1).getCell(3).value || "";
        const taxpayerGSTIN = wsBooks.getRow(2).getCell(3).value || "";
        console.log('taxpayerName (from Excel):', taxpayerName);
        console.log('taxpayerGSTIN (from Excel):', taxpayerGSTIN);

        const taxpayerNameInput = document.getElementById("taxpayerName");
        const gstinInput = document.getElementById("gstin");
        console.log('taxpayerNameInput:', taxpayerNameInput);
        console.log('gstinInput:', gstinInput);

        if (taxpayerNameInput) taxpayerNameInput.value = taxpayerName;
        if (gstinInput) gstinInput.value = taxpayerGSTIN;
    } else {
        console.log('Books worksheet not found!');
    }
} else {
    console.log('workbook not found!');
}
    // === End autofill ===
   
    booksData = books;
    portalData = portal;
    checkReadiness();
	// Reset file input so user can select the same file again
    //e.target.value = '';
}



 let booksData=[], portalData=[], excelLoaded=false;
async function extractSheetsFromFile(file){
    const workbook=new ExcelJS.Workbook();
    await workbook.xlsx.load(await file.arrayBuffer());
	const wsBooks = workbook.getWorksheet("Books");
    const wsPortal = workbook.getWorksheet("Portal");
	
		
    let foundBooks=null,foundPortal=null;
    workbook.eachSheet(ws=>{
        if(ws.name.trim().toLowerCase()==="books")foundBooks=ws;
        if(ws.name.trim().toLowerCase()==="portal")foundPortal=ws;
    });
      // <-- Change this variable to control header and data row
    const HEADER_ROW = 4;
    const DATA_START_ROW = 5;
    const parseSheet = (ws, sheetName) => {
		if (!ws) return [];
		const headers = [];
		ws.getRow(HEADER_ROW).eachCell(cell => headers.push(cell.text.trim()));
		const data = [];
		ws.eachRow((row, rowNumber) => {
			if (rowNumber < DATA_START_ROW) return;
			const obj = {};
			headers.forEach((h, idx) => {
				let value = row.getCell(idx + 1).text;
				// Only replace for Portal sheet and for columns 5, 15, 21 (1-based)
				if (sheetName === 'portal' && [5, 15, 21].includes(idx + 1)) {
					value = value.replace(/\//g, '-');
				}
				obj[h] = value;
			});
			data.push(obj);
		});
		return data;
	};
    return{
		books: foundBooks ? parseSheet(foundBooks, 'books') : [],
		portal: foundPortal ? parseSheet(foundPortal, 'portal') : [],
		workbook // <-- add this line!
    };
}

document.getElementById('importFile').addEventListener('change',handleSingleFileUpload);
function checkReadiness(){
    excelLoaded=booksData.length>0&&portalData.length>0;
    document.getElementById('reconcileBtn').disabled=!excelLoaded;
    if(excelLoaded)alert("Data have been Successfully Imported. Ready to Reconcile.");
}
function setDefaultPeriod(){
    let now=new Date();
    let y=now.getFullYear();
    let m=now.getMonth();
    if(m===0){y=y-1;m=12;}
    let mm=String(m).padStart(2,'0');
    document.getElementById('periodFrom').value=`${y}-${mm}`;
    document.getElementById('periodTo').value=`${y}-${mm}`;
}
setDefaultPeriod();
const tabOrder=["Books","Portal","FULLY_MATCHED","PARTIAL_MATCH_INVOICE","PARTIAL_MATCH_DATE","RCM","MISMATCH","MISMATCH_DATE","ONLY_BOOKS","ONLY_PORTAL"];
const tabLabels={
    "Books":"Books (Imported)","Portal":"Portal-GSTR-2B (Imported)",
    "FULLY_MATCHED":"Fully Matched","PARTIAL_MATCH_INVOICE":"Partial Match (Invoice)","PARTIAL_MATCH_DATE":"Partial Match (Date)",
    "RCM":"RCM","MISMATCH":"Mismatch","MISMATCH_DATE":"Mismatch (Date)","ONLY_BOOKS":"Only in Books","ONLY_PORTAL":"Only in Portal"
};
let resultSheets={},outputWorkbook=null;
function buildIndex(arr,keyFns){
    const idx={};
    arr.forEach((row,i)=>{
        for(const fn of keyFns){
            const k=fn(row);
            if(!idx[k])idx[k]=[];
            idx[k].push(i);
        }
    });
    return idx;
}
function getRowBooks(row){
    return{
        Date:formatDate(row["Date"]),
        Name_of_Supplier:row["Name of Supplier"]||row["Name_of_Supplier"]||"",
        GSTIN:(row["GSTIN"]||"").toUpperCase(),
        Vch_Type:row["Vch_Type"]||"",
        Vch_No:row["Vch_No."]||"",
        Invoice_No:String(row["Invoice_No."]||row["Invoice_No"]||"").toUpperCase(),
        Invoice_Date:formatDate(row["Invoice_Date"]||row["Invoice_Date."]),
        Taxable_Amount:parseNumber(row["Taxable_Amount"]),
        IGST:parseNumber(row["IGST"]),
        CGST:parseNumber(row["CGST"]),
        SGST:parseNumber(row["SGST"]),
        CESS:parseNumber(row["CESS"]),
        Total_Tax_Amount:parseNumber(row["Total_Tax_Amount"])
    };
}
function getRowPortal(row){
    return{
        GSTIN:(row["GSTIN"]||"").toUpperCase(),
        Trade_Name:row["Trade_Name"]||"",
        Invoice_No:String(row["Invoice_No."]||row["Invoice_No"]||"").toUpperCase(),
        Invoice_Type:row["Invoice_Type"]||"",
        Invoice_Date:formatDate(row["Invoice_Date"]||row["Invoice_Date."]),
        Invoice_Value:parseNumber(row["Invoice_Value"]),
        Place_of_supply:row["Place_of_supply"]||"",
        Supply_Attract_Reverse_Charge:(row["Supply_Attract_Reverse_Charge"]||"").toUpperCase(),
        Taxable_Amount:parseNumber(row["Taxable_Amount"]),
        IGST:parseNumber(row["IGST"]),
        CGST:parseNumber(row["CGST"]),
        SGST:parseNumber(row["SGST"]),
        CESS:parseNumber(row["CESS"]),
        Period:row["GSTR-1/_IFF/_GSTR-5_Period"]||"",
        Filing_Date:formatDate(row["GSTR-1/_IFF/_GSTR-5_Filing_Date"]),
        ITC_Availability:row["ITC_Availability"]||"",
        Reason:row["Reason"]||"",
        Applicable_Tax_Rate:row["Applicable_%_of_Tax_Rate"]||"",
        Source:row["Source"]||"",
        IRN:row["IRN"]||"",
        IRN_Date:formatDate(row["IRN_Date"]||"")
    };
}
function key1(obj){return normStr(obj.GSTIN)+"|"+normStr(obj.Invoice_No)+"|"+formatDate(obj.Invoice_Date);}
function key2(obj){return normStr(obj.GSTIN)+"|"+normStr(obj.Invoice_No);}
function key3(obj){return normStr(obj.GSTIN)+"|"+formatDate(obj.Invoice_Date);}
function reconcile(){
    const taxpayer=document.getElementById('taxpayerName').value.trim().toUpperCase();
    const gstin=document.getElementById('gstin').value.trim().toUpperCase();
	// Validation: require taxpayer name and GSTIN
    if (!taxpayer) {
        alert("Please enter the Name of Taxpayer before reconciling.");
        document.getElementById('taxpayerName').focus();
        return;
    }
    if (!gstin) {
        alert("Please enter the GSTIN before reconciling.");
        document.getElementById('gstin').focus();
        return;
    }
	if (!validateGSTIN(gstin)) {
                alert('Please enter a valid GSTIN (11AAAAA1111A1Z1)');
                return;
    } 
	<!-- if(!excelLoaded)return alert("Please load both Books and Portal data to reconcile."); -->
    let rounding=parseFloat(document.getElementById('rounding').value);
    let books=booksData.map(getRowBooks);
    let portal=portalData.map(getRowPortal);
    let portalIndex=buildIndex(portal,[key1,key2,key3]);
    let booksUsed=Array(books.length).fill(false);
    let portalUsed=Array(portal.length).fill(false);
    let RCM=[];
    portal.forEach((row,i)=>{
        if((row.Supply_Attract_Reverse_Charge||"")==="YES"||row.Supply_Attract_Reverse_Charge==="Y"){
            RCM.push({...row,Remarks:""});
            portalUsed[i]=true;
        }
    });
    function matchBooks(findFn,matchFn,markUsed=true){
        const result=[];
        books.forEach((b,i)=>{
            if(booksUsed[i])return;
            let idxs=findFn(b);
            let found=null,pj=-1;
            for(let j of idxs){
                if(portalUsed[j])continue;
                let p=portal[j];
                if(matchFn(b,p)){found=p;pj=j;break;}
            }
            if(found){
                if(markUsed){booksUsed[i]=true;portalUsed[pj]=true;}
                result.push([b,found,pj]);
            }
        });
        return result;
    }
    let FULLY_MATCHED=matchBooks(
        b=>portalIndex[key1(b)]||[],
        (b,p)=>["Taxable_Amount","IGST","CGST","SGST","CESS"].every(f=>floatEqual(b[f],p[f],rounding))
    ).map(([b,p])=>({
        "Name of Supplier":p.Trade_Name,GSTIN:p.GSTIN,Invoice_No:p.Invoice_No,Invoice_Date:p.Invoice_Date,
        Taxable_Amount:b.Taxable_Amount,IGST:b.IGST,CGST:b.CGST,SGST:b.SGST,CESS:b.CESS,Total_Tax_Amount:b.Total_Tax_Amount,
        Period:p.Period,Filing_Date:p.Filing_Date,Remarks:""
    }));
    let MISMATCH=matchBooks(
        b=>portalIndex[key1(b)]||[],
        (b,p)=>!["Taxable_Amount","IGST","CGST","SGST","CESS"].every(f=>floatEqual(b[f],p[f],rounding))
    ).map(([b,p])=>{
        let diff={};
        ["Taxable_Amount","IGST","CGST","SGST","CESS"].forEach(f=>{diff["Difference_"+f]=b[f]-p[f];});
        diff["Difference_Total_Tax_Amount"]=b.Total_Tax_Amount-(p.IGST+p.CGST+p.SGST+p.CESS);
        return Object.assign({
            "Name of Supplier":p.Trade_Name,GSTIN:p.GSTIN,Invoice_No:b.Invoice_No,Invoice_Date:b.Invoice_Date,
            Taxable_Amount_Books:b.Taxable_Amount,IGST_Books:b.IGST,CGST_Books:b.CGST,SGST_Books:b.SGST,CESS_Books:b.CESS,Total_Tax_Amount_Books:b.Total_Tax_Amount,
            Taxable_Amount_Portal:p.Taxable_Amount,IGST_Portal:p.IGST,CGST_Portal:p.CGST,SGST_Portal:p.SGST,CESS_Portal:p.CESS,Total_Tax_Amount_Portal:p.IGST+p.CGST+p.SGST+p.CESS,
            Period:p.Period,Filing_Date:p.Filing_Date
        },diff,{Remarks:""});
    });
    let PARTIAL_MATCH_INVOICE=matchBooks(
        b=>portalIndex[key2(b)]||[],
        (b,p)=>["Taxable_Amount","IGST","CGST","SGST","CESS"].every(f=>floatEqual(b[f],p[f],rounding))
    ).map(([b,p])=>({
        "Name of Supplier":p.Trade_Name,GSTIN:p.GSTIN,Invoice_No:b.Invoice_No,Invoice_Date_Books:b.Invoice_Date,
        Taxable_Amount:b.Taxable_Amount,IGST:b.IGST,CGST:b.CGST,SGST:b.SGST,CESS:b.CESS,Total_Tax_Amount:b.Total_Tax_Amount,
        Invoice_Date_Portal:p.Invoice_Date,Period:p.Period,Filing_Date:p.Filing_Date,Remarks:""
    }));
    let MISMATCH_DATE=matchBooks(
        b=>portalIndex[key2(b)]||[],
        (b,p)=>!["Taxable_Amount","IGST","CGST","SGST","CESS"].every(f=>floatEqual(b[f],p[f],rounding))
    ).map(([b,p])=>{
        let diff={};
        ["Taxable_Amount","IGST","CGST","SGST","CESS"].forEach(f=>{diff["Difference_"+f]=b[f]-p[f];});
        diff["Difference_Total_Tax_Amount"]=b.Total_Tax_Amount-(p.IGST+p.CGST+p.SGST+p.CESS);
        return Object.assign({
            "Name of Supplier":p.Trade_Name,GSTIN:p.GSTIN,Invoice_No_Books:b.Invoice_No,Invoice_Date_Books:b.Invoice_Date,
            Taxable_Amount_Books:b.Taxable_Amount,IGST_Books:b.IGST,CGST_Books:b.CGST,SGST_Books:b.SGST,CESS_Books:b.CESS,Total_Tax_Amount_Books:b.Total_Tax_Amount,
            Invoice_No_Portal:p.Invoice_No,Invoice_Date_Portal:p.Invoice_Date,
            Taxable_Amount_Portal:p.Taxable_Amount,IGST_Portal:p.IGST,CGST_Portal:p.CGST,SGST_Portal:p.SGST,CESS_Portal:p.CESS,Total_Tax_Amount_Portal:p.IGST+p.CGST+p.SGST+p.CESS,
            Period:p.Period,Filing_Date:p.Filing_Date
        },diff,{Remarks:""});
    });
    let PARTIAL_MATCH_DATE=matchBooks(
        b=>portalIndex[key3(b)]||[],
        (b,p)=>["Taxable_Amount","IGST","CGST","SGST","CESS"].every(f=>floatEqual(b[f],p[f],rounding))
    ).map(([b,p])=>({
        "Name of Supplier":p.Trade_Name,GSTIN:p.GSTIN,Invoice_No_Books:b.Invoice_No,Invoice_Date:b.Invoice_Date,
        Taxable_Amount:b.Taxable_Amount,IGST:b.IGST,CGST:b.CGST,SGST:b.SGST,CESS:b.CESS,Total_Tax_Amount:b.Total_Tax_Amount,
        Invoice_No_Portal:p.Invoice_No,Period:p.Period,Filing_Date:p.Filing_Date,Remarks:""
    }));
    let ONLY_BOOKS=books.filter((_,i)=>!booksUsed[i]).map(b=>({
        "Name of Supplier":b.Name_of_Supplier,GSTIN:b.GSTIN,Invoice_No:b.Invoice_No,Invoice_Date:b.Invoice_Date,
        Taxable_Amount:b.Taxable_Amount,IGST:b.IGST,CGST:b.CGST,SGST:b.SGST,CESS:b.CESS,Total_Tax_Amount:b.Total_Tax_Amount,Remarks:""
    }));
    let ONLY_PORTAL=portal.filter((_,j)=>!portalUsed[j]).map(p=>({
        GSTIN:p.GSTIN,Trade_Name:p.Trade_Name,Invoice_No:p.Invoice_No,Invoice_Type:p.Invoice_Type,Invoice_Date:p.Invoice_Date,
        Taxable_Amount:p.Taxable_Amount,IGST:p.IGST,CGST:p.CGST,SGST:p.SGST,CESS:p.CESS,Period:p.Period,Filing_Date:p.Filing_Date,Remarks:""
    }));
    resultSheets={Books:books,Portal:portal,FULLY_MATCHED,PARTIAL_MATCH_INVOICE,PARTIAL_MATCH_DATE,RCM,MISMATCH,MISMATCH_DATE,ONLY_BOOKS,ONLY_PORTAL};
    showTabs();
    document.getElementById('downloadBtn').style.display="inline-block";
    document.getElementById('downloadBtn').disabled=false;
    outputWorkbook=null;
    alert("Reconciliation Done! View Results in tabs below.");
}
function showTabs(){
    let tabsDiv=document.getElementById('tabs');
    let tabContentsDiv=document.getElementById('tabContents');
    let tabsHtml='',tabContentsHtml='',firstActive='';
    for(let tab of tabOrder){
        if(!resultSheets[tab])continue;
        if(!firstActive)firstActive=tab;
        tabsHtml+=`<div class="tab${tab===firstActive?' active':''}" data-tabname="${tab}" onclick="activateTab('${tab}')">${tabLabels[tab]||tab}</div>`;
        let tableHtml=renderTable(tab,resultSheets[tab]);
        tabContentsHtml+=`<div class="tab-content${tab===firstActive?' active':''}" id="tab-content-${tab}">${tableHtml}</div>`;
    }
    tabsDiv.innerHTML=tabsHtml;
    tabContentsDiv.innerHTML=tabContentsHtml;
    document.getElementById('tabsContainer').style.display="block";
}
function activateTab(tab){
    document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
    document.querySelector(`.tab[data-tabname="${tab}"]`).classList.add('active');
    document.getElementById('tab-content-'+tab).classList.add('active');
}
function renderTable(sheetName,rows){
    if(!rows||rows.length===0)return"<div>No records found.</div>";
    let cols=Object.keys(rows[0]);
    let rightCols=cols.filter(c=>!/(Date|Invoice_No|Invoice_Type|Trade_Name|Name|Remarks)/i.test(c));
    let redCols=[];
    if(["PARTIAL_MATCH_INVOICE"].includes(sheetName))redCols=["Invoice_Date_Books","Invoice_Date_Portal"];
    if(["PARTIAL_MATCH_DATE"].includes(sheetName))redCols=["Invoice_No_Books","Invoice_No_Portal"];
    if(["MISMATCH","MISMATCH_DATE"].includes(sheetName))redCols=cols.filter(c=>/^Difference_/.test(c)||/Invoice_No_Books|Invoice_Date_Books|Invoice_No_Portal|Invoice_Date_Portal/.test(c));
    let ths=cols.map(c=>`<th class="wrap${rightCols.includes(c)?' right':' text'}">${c.replace(/_/g," ")}</th>`).join("");
    let tdsAll="",totals={};
    rows.forEach(row=>{
        let tr="";
        cols.forEach(c=>{
            let val=row[c],style="",cellClass="";
            if(rightCols.includes(c)&&typeof val==='number'){
                val=formatIndianNumber(val);style='style="text-align:right"';
                totals[c]=(totals[c]||0)+parseNumber(row[c]);
            }
            if(/(Date)/i.test(c)&&val&&val.toString().length>0){
                val=formatDate(val);style='style="text-align:right"';
            }
            if(redCols.includes(c))cellClass+=' red-bold';
            tr+=`<td class="${cellClass}${rightCols.includes(c)?' right':' text'}" ${style}>${val||""}</td>`;
        });
        tdsAll+=`<tr>${tr}</tr>`;
    });
    let anyTotal=cols.some(c=>rightCols.includes(c));
    let totalRow="";
    if(anyTotal){
        let tr="";
        cols.forEach(c=>{
            if(rightCols.includes(c)){
                let v=totals[c]===0 ? "0.00" : formatIndianNumber(totals[c]||0);
                tr+=`<td class="right" style="font-weight:bold">${v}</td>`;
            }else tr+="<td></td>";
        });
        totalRow=`<tr style="background:#f9f9be;font-weight:bold"><td colspan="${cols.length}" style="text-align:left;padding-left:9px;font-style:italic;font-size:0.96em"><b>Totals:</b></td></tr><tr>${tr}</tr>`;
    }
    return`<table><thead><tr>${ths}</tr></thead><tbody>${tdsAll}${totalRow}</tbody></table>`;
}
async function downloadOutput() {
	const taxpayer=document.getElementById('taxpayerName').value.trim().toUpperCase();
    const gstin=document.getElementById('gstin').value.trim().toUpperCase();
    const periodFrom=document.getElementById('periodFrom').value;
    const periodTo=document.getElementById('periodTo').value;
    const formatPeriod=(p)=>p?(new Date(p+"-01")).toLocaleString("en-IN",{month:"short",year:"numeric"}).replace(" ","-"):"";
    const numberCols=["Taxable Amount","IGST","CGST","SGST","CESS","Total Tax Amount",
        "Taxable Amount Books","IGST Books","CGST Books","SGST Books","CESS Books","Total Tax Amount Books",
        "Taxable Amount Portal","IGST Portal","CGST Portal","SGST Portal","CESS Portal","Total Tax Amount Portal",
        "Difference Taxable Amount","Difference IGST","Difference CGST","Difference SGST","Difference CESS","Difference Total Tax Amount"
    ];
    function isNumberCol(header){
        return numberCols.map(h=>h.toLowerCase().replace(/[^a-z]/g,"")).includes(header.replace(/[^a-z]/gi,"").toLowerCase());
    }
    function formatIndianExcel(cell){
        // cell.numFmt = '_-* #,##,##0.00_-;-* #,##,##0.00_-;_-* 0.00_-;_-@_-';
		cell.numFmt = '#,##,##0.00;-#,##,##0.00;0.00;@';
        cell.alignment = { vertical: "middle", horizontal: "right", wrapText: true };
    }
    function fixRowHeight(row){ if(!row.height||row.height<18) row.height=18; }
    function getSummary(tab, col, which) {
        const rows = resultSheets[tab] || [];
        if(col==="count") return rows.length;
        if((tab==="MISMATCH"||tab==="MISMATCH_DATE") && which) {
            let suffix = which==="Books" ? "_Books" : "_Portal";
            if(col==="Total_Tax_Amount") return rows.reduce((a,r)=>a+(Number(r["Total_Tax_Amount"+suffix])||0),0);
            if(col==="Taxable_Amount"||col==="IGST"||col==="CGST"||col==="SGST"||col==="CESS")
                return rows.reduce((a,r)=>a+(Number(r[col+suffix])||0),0);
        }
        return rows.reduce((a, r) => a + (Number(r[col]) || 0), 0);
    }
    function addSummarySheet(wb){
        const ws=wb.addWorksheet("Summary");
        const merges=["A1:H1","A2:H2","A3:H3","A4:H4","A6:H6","A8:H8","A21:H21","A35:H35"];
        merges.forEach(range=>{try{ws.mergeCells(range);}catch(e){}});
        ws.getCell("A1").value='GST RECONCILIATION SUMMARY';
        ws.getCell("A1").font={name:"Bookman Old Style",size:20,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A1").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
        ws.getCell("A1").alignment={horizontal:"center",vertical:"center"};
        // ws.getCell("A2").value=`TAXPAYER: ${taxpayer}`;
		ws.getCell("A2").value= taxpayer;
        ws.getCell("A2").font={name:"Bookman Old Style",size:18,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A2").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
        ws.getCell("A2").alignment={horizontal:"center",vertical:"center"};
        ws.getCell("A3").value=`GSTIN: ${gstin}`;
        ws.getCell("A3").font={name:"Bookman Old Style",size:16,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A3").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
        ws.getCell("A3").alignment={horizontal:"center",vertical:"center"};
        ws.getCell("A4").value=`Period: ${formatPeriod(periodFrom)} to ${formatPeriod(periodTo)}`;
        ws.getCell("A4").font={name:"Bookman Old Style",size:14,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A4").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
        ws.getCell("A4").alignment={horizontal:"center",vertical:"center"};
        ws.getCell("A6").value='SHEET INDEX & TOTALS';
        ws.getCell("A6").font={name:"Bookman Old Style",size:14,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A6").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
        ws.getCell("A6").alignment={horizontal:"center",vertical:"center"};
        [
            ["A7","Sheet Name"],["B7","No. of Invoices"],["C7","Taxable Amount"],["D7","IGST"],
            ["E7","CGST"],["F7","SGST"],["G7","CESS"],["H7","Total Tax Amount"]
        ].forEach(([cell,val])=>{
            ws.getCell(cell).value=val;
            ws.getCell(cell).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FF222222"}};
            ws.getCell(cell).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFD9E1F2"}};
            ws.getCell(cell).alignment={horizontal:"center",vertical:"center",wrapText:true};
            ws.getCell(cell).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
        });
        ws.getCell("A8").value="Books Records";
        ws.getCell("A8").font={name:"Bookman Old Style",size:13,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A8").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
        ws.getCell("A8").alignment={horizontal:"center",vertical:"center"};
        // Books Section
        let booksRows=[
            {tab:"FULLY_MATCHED",label:"Fully Matched"},
            {tab:"PARTIAL_MATCH_INVOICE",label:"Partial Match Invoice"},
            {tab:"PARTIAL_MATCH_DATE",label:"Partial Match Date"},
            {tab:"MISMATCH",label:"Mismatch",books:true},
            {tab:"MISMATCH_DATE",label:"Mismatch Date",books:true},
            {tab:"ONLY_BOOKS",label:"Only Books"}
        ];

		// Helper to get numeric value from a cell (handles possible object from formulas)
		function getCellNumber(cell) {
			let v = cell.value;
			if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
			return (typeof v === 'number') ? v : parseFloat(v) || 0;
		}

		// BOOKS SECTION
		booksRows.forEach((row,i)=>{
			let n=9+i;let tab=row.tab;let books=!!row.books;
			let which = (tab==="MISMATCH"||tab==="MISMATCH_DATE") ? "Books" : null;
			ws.getCell(`A${n}`).value=row.label;
			ws.getCell(`A${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			ws.getCell(`A${n}`).alignment={horizontal:"left",vertical:"center"};
			ws.getCell(`A${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`A${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFFFF"}};
			ws.getCell(`B${n}`).value=getSummary(tab,"count");
			ws.getCell(`B${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			ws.getCell(`B${n}`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`B${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`B${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
			ws.getCell(`C${n}`).value=getSummary(tab,"Taxable_Amount",which);
			ws.getCell(`D${n}`).value=getSummary(tab,"IGST",which);
			ws.getCell(`E${n}`).value=getSummary(tab,"CGST",which);
			ws.getCell(`F${n}`).value=getSummary(tab,"SGST",which);
			ws.getCell(`G${n}`).value=getSummary(tab,"CESS",which);
			for(let col of["C","E","G"]){
				ws.getCell(`${col}${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
				formatIndianExcel(ws.getCell(`${col}${n}`));
				ws.getCell(`${col}${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
				ws.getCell(`${col}${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFFFF"}};
			}
			for(let col of["D","F"]){
				ws.getCell(`${col}${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
				formatIndianExcel(ws.getCell(`${col}${n}`));
				ws.getCell(`${col}${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
				ws.getCell(`${col}${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
			}
			// Hn = SUM(Dn:Gn) as value
			let sumH = 0;
			for (let col of ["D","E","F","G"]) {
				let v = ws.getCell(`${col}${n}`).value;
				if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
				v = (typeof v === 'number') ? v : parseFloat(v) || 0;
				sumH += v;
			}
			ws.getCell(`H${n}`).value = sumH;
			ws.getCell(`H${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			formatIndianExcel(ws.getCell(`H${n}`));
			ws.getCell(`H${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`H${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
		});
		// Hide rows 15 & 16 (Books section totals)
		ws.getRow(15).hidden = true; ws.getRow(16).hidden = true;
		ws.getCell("A17").value="Total";
		ws.getCell("A17").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A17").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
		ws.getCell("A17").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A17").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		// B17 = SUM(B9:B14) as value
		let sumB17 = 0;
		for(let i=9; i<=14; ++i){
			let v = ws.getCell(`B${i}`).value;
			if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
			v = (typeof v === 'number') ? v : parseFloat(v) || 0;
			sumB17 += v;
		}
		ws.getCell("B17").value = sumB17;
		ws.getCell("B17").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B17").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
		ws.getCell("B17").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B17").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		for(let col of["C","D","E","F","G","H"]){
			let sum = 0;
			for(let i=9;i<=14;++i){
				let v = ws.getCell(`${col}${i}`).value;
				if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
				v = (typeof v === 'number') ? v : parseFloat(v) || 0;
				sum += v;
			}
			ws.getCell(`${col}17`).value = sum;
			ws.getCell(`${col}17`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}17`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
			ws.getCell(`${col}17`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}17`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}17`));
		}
		ws.getCell("A18").value="Books Records Total";
		ws.getCell("A18").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A18").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("A18").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A18").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		ws.getCell("B18").value=getSummary("Books","count");
		ws.getCell("B18").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B18").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("B18").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B18").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		for(let col of["C","D","E","F","G"]){
			let f={"C":"Taxable_Amount","D":"IGST","E":"CGST","F":"SGST","G":"CESS"}[col];
			ws.getCell(`${col}18`).value=getSummary("Books",f);
			ws.getCell(`${col}18`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}18`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
			ws.getCell(`${col}18`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}18`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}18`));
		}
		// H18 = SUM(D18:G18) as value
		let sumH18 = 0;
		for(let col of ["D","E","F","G"]){
			let v = ws.getCell(`${col}18`).value;
			if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
			v = (typeof v === 'number') ? v : parseFloat(v) || 0;
			sumH18 += v;
		}
		ws.getCell("H18").value = sumH18;
		ws.getCell("H18").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("H18").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("H18").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("H18").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		formatIndianExcel(ws.getCell("H18"));

		ws.getCell("A19").value="Difference";
		ws.getCell("A19").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A19").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
		ws.getCell("A19").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A19").border={top:{style:"thin"},bottom:{style:"thin"}};
		// B19 = B17 - B18 as value
		let vB17 = getCellNumber(ws.getCell("B17"));
		let vB18 = getCellNumber(ws.getCell("B18"));
		ws.getCell("B19").value = vB17 - vB18;
		ws.getCell("B19").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B19").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
		ws.getCell("B19").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B19").border={top:{style:"thin"},bottom:{style:"thin"}};
		for(let col of["C","D","E","F","G","H"]){
			let v17 = getCellNumber(ws.getCell(`${col}17`));
			let v18 = getCellNumber(ws.getCell(`${col}18`));
			ws.getCell(`${col}19`).value = v17 - v18;
			ws.getCell(`${col}19`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}19`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
			ws.getCell(`${col}19`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}19`).border={top:{style:"thin"},bottom:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}19`));
		}

		// PORTAL SECTION
		ws.getCell("A21").value="Portal Records";
		ws.getCell("A21").font={name:"Bookman Old Style",size:13,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A21").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
		ws.getCell("A21").alignment={horizontal:"center",vertical:"center"};
		let portalRows=[
			{tab:"FULLY_MATCHED",label:"Fully Matched"},
			{tab:"PARTIAL_MATCH_INVOICE",label:"Partial Match Invoice"},
			{tab:"PARTIAL_MATCH_DATE",label:"Partial Match Date"},
			{tab:"MISMATCH",label:"Mismatch",portal:true},
			{tab:"MISMATCH_DATE",label:"Mismatch Date",portal:true},
			{tab:"RCM",label:"RCM"},
			{tab:"ONLY_PORTAL",label:"Only Portal"}
		];
		portalRows.forEach((row,i)=>{
			let n=22+i;let tab=row.tab;let portal=!!row.portal;
			let which = (tab==="MISMATCH"||tab==="MISMATCH_DATE") ? "Portal" : null;
			ws.getCell(`A${n}`).value=row.label;
			ws.getCell(`A${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			ws.getCell(`A${n}`).alignment={horizontal:"left",vertical:"center"};
			ws.getCell(`A${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`A${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFFFF"}};
			ws.getCell(`B${n}`).value=getSummary(tab,"count");
			ws.getCell(`B${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			ws.getCell(`B${n}`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`B${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`B${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
			ws.getCell(`C${n}`).value=getSummary(tab,"Taxable_Amount",which);
			ws.getCell(`D${n}`).value=getSummary(tab,"IGST",which);
			ws.getCell(`E${n}`).value=getSummary(tab,"CGST",which);
			ws.getCell(`F${n}`).value=getSummary(tab,"SGST",which);
			ws.getCell(`G${n}`).value=getSummary(tab,"CESS",which);
			for(let col of["C","E","G"]){
				ws.getCell(`${col}${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
				formatIndianExcel(ws.getCell(`${col}${n}`));
				ws.getCell(`${col}${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
				ws.getCell(`${col}${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFFFF"}};
			}
			for(let col of["D","F"]){
				ws.getCell(`${col}${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
				formatIndianExcel(ws.getCell(`${col}${n}`));
				ws.getCell(`${col}${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
				ws.getCell(`${col}${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
			}
			// Hn = SUM(Dn:Gn) as value
			let sumH = 0;
			for (let col of ["D","E","F","G"]) {
				let v = ws.getCell(`${col}${n}`).value;
				if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
				v = (typeof v === 'number') ? v : parseFloat(v) || 0;
				sumH += v;
			}
			ws.getCell(`H${n}`).value = sumH;
			ws.getCell(`H${n}`).font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
			formatIndianExcel(ws.getCell(`H${n}`));
			ws.getCell(`H${n}`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			ws.getCell(`H${n}`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFF2F2F2"}};
		});
		// Hide rows 29 & 30 (Portal section totals)
		ws.getRow(29).hidden=true;ws.getRow(30).hidden=true;
		ws.getCell("A31").value="Total";
		ws.getCell("A31").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A31").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
		ws.getCell("A31").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A31").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		// B31 = SUM(B22:B28) as value
		let sumB31 = 0;
		for(let i=22;i<=28;++i){
			let v = ws.getCell(`B${i}`).value;
			if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
			v = (typeof v === 'number') ? v : parseFloat(v) || 0;
			sumB31 += v;
		}
		ws.getCell("B31").value = sumB31;
		ws.getCell("B31").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B31").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
		ws.getCell("B31").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B31").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		for(let col of["C","D","E","F","G","H"]){
			let sum = 0;
			for(let i=22;i<=28;++i){
				let v = ws.getCell(`${col}${i}`).value;
				if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
				v = (typeof v === 'number') ? v : parseFloat(v) || 0;
				sum += v;
			}
			ws.getCell(`${col}31`).value = sum;
			ws.getCell(`${col}31`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}31`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};
			ws.getCell(`${col}31`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}31`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}31`));
		}
		ws.getCell("A32").value="Portal Records Total";
		ws.getCell("B32").value=getSummary("Portal","count");
		ws.getCell("A32").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A32").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("A32").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A32").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		ws.getCell("B32").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B32").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("B32").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B32").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		for(let col of["C","D","E","F","G"]){
			let f={"C":"Taxable_Amount","D":"IGST","E":"CGST","F":"SGST","G":"CESS"}[col];
			ws.getCell(`${col}32`).value=getSummary("Portal",f);
			ws.getCell(`${col}32`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}32`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
			ws.getCell(`${col}32`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}32`).border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}32`));
		}
		// H32 = SUM(D32:G32) as value
		let sumH32 = 0;
		for(let col of ["D","E","F","G"]){
			let v = ws.getCell(`${col}32`).value;
			if (typeof v === 'object' && v !== null && 'result' in v) v = v.result;
			v = (typeof v === 'number') ? v : parseFloat(v) || 0;
			sumH32 += v;
		}
		ws.getCell("H32").value = sumH32;
		ws.getCell("H32").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("H32").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
		ws.getCell("H32").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("H32").border={top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}};
		formatIndianExcel(ws.getCell("H32"));
		ws.getCell("A33").value="Difference";
		ws.getCell("A33").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("A33").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
		ws.getCell("A33").alignment={horizontal:"left",vertical:"center"};
		ws.getCell("A33").border={top:{style:"thin"},bottom:{style:"thin"}};
		// B33 = B31 - B32 as value
		let vB31 = getCellNumber(ws.getCell("B31"));
		let vB32 = getCellNumber(ws.getCell("B32"));
		ws.getCell("B33").value = vB31 - vB32;
		ws.getCell("B33").font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
		ws.getCell("B33").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
		ws.getCell("B33").alignment={horizontal:"right",vertical:"center"};
		ws.getCell("B33").border={top:{style:"thin"},bottom:{style:"thin"}};
		for(let col of["C","D","E","F","G","H"]){
			let v31 = getCellNumber(ws.getCell(`${col}31`));
			let v32 = getCellNumber(ws.getCell(`${col}32`));
			ws.getCell(`${col}33`).value = v31 - v32;
			ws.getCell(`${col}33`).font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
			ws.getCell(`${col}33`).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFF0000"}};
			ws.getCell(`${col}33`).alignment={horizontal:"right",vertical:"center"};
			ws.getCell(`${col}33`).border={top:{style:"thin"},bottom:{style:"thin"}};
			formatIndianExcel(ws.getCell(`${col}33`));
		}

        ws.getCell("A35").value="INSTRUCTIONS:";
        ws.getCell("A35").font={name:"Bookman Old Style",size:14,bold:true,color:{argb:"FFFFFFFF"}};
        ws.getCell("A35").fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
        ws.getCell("A35").alignment={horizontal:"left",vertical:"center"};
	let instrRows=[
          	"- This Excel is generated from GST Reconciliation Tool Designed & Developed by M/s HNVB & ASSOCIATES, Chartered Accountants.",
			"- Each tab contains a different reconciliation or summary.",
            "- See above for each sheet's entry and its overall totals.",
            "- This Summary is auto-generated with summary & links.",
            "- Navigate using the sheet tabs below."
        ];
        for(let i=0;i<instrRows.length;++i){
            let cell=ws.getCell(`A${36+i}`);
            cell.value=instrRows[i];
            cell.font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
            cell.alignment={horizontal:"left",vertical:"center"};
        }
        // for(let i=1;i<=8;++i)ws.getColumn(i).width=22;
		for(let i=1;i<=8;++i) {
		let column = ws.getColumn(i);
		column.width= 25;
		}
		for(let i=1; i<=1; ++i) {
		let row = ws.getRow(i);
		if(row.cellCount === 0) row.getCell(1).value = ''; // force row to exist
		row.height = 28;
		}
		for(let i=2; i<=50; ++i) {
		let row = ws.getRow(i);
		if(row.cellCount === 0) row.getCell(1).value = ''; // force row to exist
		row.height = 18;
		}
    }

    // --- Actual Output Generation ---
    const fixedWidths = {
        "Date": 16, "Name of Supplier": 35, "GSTIN": 26, "Vch Type": 18, "Vch No": 25, "Invoice No": 25, "Invoice Date": 16,
        "Taxable Amount": 18, "IGST": 18, "CGST": 18, "SGST": 18, "CESS": 18, "Total Tax Amount": 18, "Remarks": 35,
        "Trade Name": 35, "Invoice Type": 12, "Invoice Value": 18, "Place of supply": 12, "Supply Attract Reverse Charge": 16,
        "Period": 12, "Filing Date": 16, "ITC Availability": 12, "Reason": 12, "Applicable Tax Rate": 12, "Source": 12,
        "IRN": 12, "IRN Date": 16,
        "Invoice Date Books": 16, "Invoice Date Portal": 16, "Invoice No Books": 25, "Invoice No Portal": 25,
        "Taxable Amount Books": 18, "IGST Books": 18, "CGST Books": 18, "SGST Books": 18, "CESS Books": 18, "Total Tax Amount Books": 18,
        "Taxable Amount Portal": 18, "IGST Portal": 18, "CGST Portal": 18, "SGST Portal": 18, "CESS Portal": 18, "Total Tax Amount Portal": 18,
        "Difference Taxable Amount": 18, "Difference IGST": 18, "Difference CGST": 18, "Difference SGST": 18, "Difference CESS": 18, "Difference Total Tax Amount": 18
    };
    const sheetColorPalettes = {
        "BOOKS":          { main: "FFED7D31", text: "FFFFFFFF" },
        "ONLY_BOOKS":     { main: "FFED7D31", text: "FFFFFFFF" },
        "ONLY_PORTAL":    { main: "FF4472C4", text: "FFFFFFFF" },
        "PORTAL":         { main: "FF4472C4", text: "FFFFFFFF" },
        "RCM":            { main: "FF4472C4", text: "FFFFFFFF" },
        "MISMATCH":       { main: "FF4472C4", text: "FFFFFFFF" },
        "MISMATCH_DATE":  { main: "FF4472C4", text: "FFFFFFFF" },
        "FULLY_MATCHED":  { main: "FF70AD47", text: "FFFFFFFF" },
        "PARTIAL_MATCH_INVOICE": { main: "FFC6E0B4", text: "FF222222" },
        "PARTIAL_MATCH_DATE":    { main: "FFC6E0B4", text: "FF222222" }
    };
    function getPalette(tab){
        const def={main:"FFCCCCCC",text:"FF222222"};
        const base=sheetColorPalettes[tab]||def;
        return{header:base.main,headerText:base.text,total:base.main};
    }
    const prettifyHeader=h=>h.replace(/_/g,' ').replace(/([A-Z])/g,' $1').replace(/\s+/g,' ').replace(/\bG S T I N\b/gi,"GSTIN").replace(/\bI G S T\b/gi,"IGST").replace(/\bC G S T\b/gi,"CGST").replace(/\bS G S T\b/gi,"SGST").replace(/\bC E S S\b/gi,"CESS").replace(/\bI T C\b/gi,"ITC").replace(/\bI R N\b/gi,"IRN").trim();
    const normalizeHeader=header=>header.replace(/\s+/g,"").replace(/_/g,"").toLowerCase();

    let workbook = new ExcelJS.Workbook();
    workbook.creator="GST Reconciliation Tool";
    workbook.created=new Date();
    addSummarySheet(workbook);
    for(let tab of tabOrder){
        const rows=resultSheets[tab];
        if(!rows||rows.length===0)continue;
        const palette=getPalette(tab);
        const cols=Object.keys(rows[0]);
        const displayHeaders=cols.map(prettifyHeader);
        const sheet=workbook.addWorksheet(tab);
		const sheetDescriptions = {
		"Books": "DETAILS OF ITC AS PER BOOKS",
		 "Portal": "DETAILS OF ITC AS PER GSTR 2B",
		 "FULLY_MATCHED": "DETAILS OF FULLY  MATCHED ITC",
		 "PARTIAL_MATCH_INVOICE": "DETAILS OF PARTIAL MATCH ITC BY INVOICE NO",
		 "PARTIAL_MATCH_DATE": "DETAILS OF PARTIAL MATCH ITC BY INVOICE DATE",
		 "ONLY_BOOKS": "DETAILS OF ITC ONLY AVAILABLE IN BOOKS (NOT REFLECTED IN GSTR-2B)",
		 "ONLY_PORTAL": "DETAILS OF ITC ONLY AVAILABLE IN GSTR-2B  (NOT ENTERED IN BOOKS)",
		 "RCM": "DETAILS OF RCM TRANSACTIONS (AS REFLECTED IN GSTR 2B FOR THE PERIOD)",
		 "MISMATCH": "DETAILS OF ITC AMOUNT MISMATCH IN BOOKS & PORTAL",
		 "MISMATCH_DATE": "DETAILS OF ITC AMOUNT & DATE MISMATCH IN BOOKS & PORTAL"
		};

		const descriptionLine = {
		  val: sheetDescriptions[tab] || "",
		  font: { name: "Bookman Old Style", size: 14, bold: true, color: { argb: "FF08509c" } }
		};
        [
            {val:taxpayer,font:{name:"Bookman Old Style",size:20,bold:true,color:{argb:"FF08509c"}}},
            {val:"GSTIN: "+gstin,font:{name:"Bookman Old Style",size:16,bold:true,color:{argb:"FF08509c"}}},
            {val:(periodFrom||periodTo)?`Period: ${formatPeriod(periodFrom)} to ${formatPeriod(periodTo)}`:"",font:{name:"Bookman Old Style",size:14,bold:true,color:{argb:"FF08509c"}}},
			descriptionLine // <-- This adds the custom line
        ].forEach((h,idx)=>{
            sheet.mergeCells(idx+1,1,idx+1,cols.length);
            let cell=sheet.getCell(idx+1,1);
            cell.value=h.val;
            cell.font=h.font;
            cell.alignment={vertical:"middle",horizontal:"left"};
            // fixRowHeight(sheet.getRow(idx+1));
			sheet.getRow(idx + 1).height = 24; // Set row height to 24
        });
        sheet.addRow([]);
        let headerRow=sheet.addRow(displayHeaders);
        headerRow.height=Math.max(54,...displayHeaders.map((header,i)=>{
        let colWidth=fixedWidths[header]||12;
			return 18*Math.ceil(header.length/Math.max(1,Math.floor(colWidth*1.2)));
        }));
        headerRow.eachCell((cell,idx)=>{
            cell.font={name:"Bookman Old Style",size:12,bold:true,color:{argb:"FFFFFFFF"}};
            cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFED7D31"}};
            cell.border={top:{style:"thin"},left:{style:"thin"},right:{style:"thin"},bottom:{style:"thin"}};
            cell.alignment={vertical:"middle",horizontal:"center",wrapText:true};
        });
        const nameSupplierColIdx=displayHeaders.findIndex(c=>normalizeHeader(c)==="nameofsupplier");
        const tradeNameColIdx=displayHeaders.findIndex(c=>normalizeHeader(c)==="tradename");
        let redCols=[];
        if(tab==="PARTIAL_MATCH_INVOICE")redCols=["Invoice Date Books","Invoice Date Portal"];
        else if(tab==="PARTIAL_MATCH_DATE")redCols=["Invoice No Books","Invoice No Portal"];
		else if(tab==="MISMATCH")redCols=["Difference Taxable Amount","Difference IGST","Difference CGST","Difference SGST","Difference CESS","Difference Total Tax Amount"];
		else if(tab==="MISMATCH_DATE")redCols=["Invoice Date Books","Invoice Date Portal","Difference Taxable Amount","Difference IGST","Difference CGST","Difference SGST","Difference CESS","Difference Total Tax Amount"];
        //else if(tab==="MISMATCH"||tab==="MISMATCH_DATE"){
          //  redCols=cols.filter(cn=>/	^Difference_/.test(cn)||/Invoice No Books|Invoice Date Books|Invoice No Portal|Invoice Date Portal/.test(cn)).map(prettifyHeader);
        // }
        let totals={},dataRowNum=0;
        rows.forEach(r=>{
            let arr=cols.map((c,ix)=>{
                let headerName=displayHeaders[ix];
                let val=r[c];
                if(typeof val==="number"&&isNumberCol(headerName)) return val;
                if(/(Date)/i.test(headerName)&&val) return formatDate(val);
                return val;
            });
            cols.forEach((c,ix)=>{
                const headerName=displayHeaders[ix];
                if(typeof r[c]==="number"&&isNumberCol(headerName))totals[c]=(totals[c]||0)+r[c];
            });
            let dataRow=sheet.addRow(arr);
			//dataRow.height = 18;
            dataRow.eachCell((cell,colNumber)=>{
                const colIdx=colNumber-1;
                const colName=displayHeaders[colIdx];
                if(typeof arr[colIdx]==="number"&&isNumberCol(colName)){
                    formatIndianExcel(cell);
                } else if(/(Date)/i.test(colName)){
                    cell.alignment={vertical:"middle",horizontal:"right",wrapText:true};
                } else {
                    cell.alignment={vertical:"middle",horizontal:"left",wrapText:true};
                }
                cell.font={name:"Bookman Old Style",size:11,color:{argb:"FF222222"}};
                cell.border={top:{style:"thin"},left:{style:"thin"},right:{style:"thin"},bottom:{style:"thin"}};
                if(redCols.length&&redCols.includes(colName)){
                    cell.font={...cell.font,color:{argb:"FFD0001C"},bold:true}
                }
                cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:"FFFFFFFF"}};
            });
            dataRowNum++;
        });
        // Totals Row for all sheets (including MISMATCH & MISMATCH_DATE)
        if(cols.some((c,ix)=>isNumberCol(displayHeaders[ix]))){
            sheet.addRow([]);
            let totalArr=cols.map((c,ix)=>isNumberCol(displayHeaders[ix])?(totals[c]===0?"0.00":totals[c]):"");
            let totalHeaderRow=sheet.addRow([]);
            totalHeaderRow.height=18;
            totalHeaderRow.getCell(1).value="Totals:";
            totalHeaderRow.getCell(1).font = {bold:true,color:{argb:palette.header},name:"Bookman Old Style"};
            totalHeaderRow.getCell(1).fill = {type:"pattern",pattern:"solid",fgColor:{argb:palette.total}};
            totalHeaderRow.getCell(1).alignment = {vertical:"middle",horizontal:"left",wrapText:true};
            sheet.mergeCells(totalHeaderRow.number, 1, totalHeaderRow.number, cols.length);
            let totalRow=sheet.addRow(totalArr);
            totalRow.height=18;
            totalRow.eachCell((cell,colNumber)=>{
                const colIdx=colNumber-1;
                const colName=displayHeaders[colIdx];
                if(isNumberCol(colName)){
                    formatIndianExcel(cell);
                }else if(/(Date)/i.test(colName)){
                    cell.alignment={vertical:"middle",horizontal:"right",wrapText:true};
                }else{
                    cell.alignment={vertical:"middle",horizontal:"left",wrapText:true};
                }
                cell.font={name:"Bookman Old Style",bold:true,color:{argb:palette.headerText}};
                cell.border={top:{style:"thin"},left:{style:"thin"},right:{style:"thin"},bottom:{style:"thin"}};
                cell.fill={type:"pattern",pattern:"solid",fgColor:{argb:palette.header}};
            });
        }
        displayHeaders.forEach((header, i) => {
			sheet.getColumn(i + 1).width = fixedWidths[header] || 12;
		});
		// displayHeaders.forEach((header,i)=>{sheet.getColumn(i+1).width=22;});
        // sheet.eachRow((row,rowNumber)=>{if(!row.height||row.height<18) row.height=18;});
    }
    const buf=await workbook.xlsx.writeBuffer();
    saveAs(new Blob([buf]),"GST_Reconciliation_Output.xlsx");
}

// --- UI/UX: Add onscreen summary tab with business style ---
if (!tabOrder.includes("Summary")) tabOrder.unshift("Summary");

function generateSummaryHTML() {
    // Helper functions
    const getSummary = (tab, col, which) => {
        const rows = resultSheets[tab] || [];
        if (col === "count") return rows.length;
        if ((tab === "MISMATCH" || tab === "MISMATCH_DATE") && which) {
            let suffix = which === "Books" ? "_Books" : "_Portal";
            if (col === "Total_Tax_Amount") return rows.reduce((a, r) => a + (Number(r["Total_Tax_Amount" + suffix]) || 0), 0);
            if (["Taxable_Amount", "IGST", "CGST", "SGST", "CESS"].includes(col))
                return rows.reduce((a, r) => a + (Number(r[col + suffix]) || 0), 0);
        }
        return rows.reduce((a, r) => a + (Number(r[col]) || 0), 0);
    };
    function formatIndianNumber(num) {
        if (isNaN(num) || num === null || num === "") return "";
        num = Number(num);
        let [int, dec] = num.toFixed(2).split(".");
        let lastThree = int.substring(int.length - 3);
        let otherNumbers = int.substring(0, int.length - 3);
        if (otherNumbers !== "") lastThree = "," + lastThree;
        return otherNumbers.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + lastThree + (dec ? "." + dec : "");
    }

    // Book side summary rows
    const booksRows = [
        { tab: "FULLY_MATCHED", label: "Fully Matched" },
        { tab: "PARTIAL_MATCH_INVOICE", label: "Partial Match Invoice" },
        { tab: "PARTIAL_MATCH_DATE", label: "Partial Match Date" },
        { tab: "MISMATCH", label: "Mismatch", books: true },
        { tab: "MISMATCH_DATE", label: "Mismatch Date", books: true },
        { tab: "ONLY_BOOKS", label: "Only Books" }
    ];
    // Portal side summary rows
    const portalRows = [
        { tab: "FULLY_MATCHED", label: "Fully Matched" },
        { tab: "PARTIAL_MATCH_INVOICE", label: "Partial Match Invoice" },
        { tab: "PARTIAL_MATCH_DATE", label: "Partial Match Date" },
        { tab: "MISMATCH", label: "Mismatch", portal: true },
        { tab: "MISMATCH_DATE", label: "Mismatch Date", portal: true },
        { tab: "RCM", label: "RCM" },
        { tab: "ONLY_PORTAL", label: "Only Portal" }
    ];

    let html = `
    <h2 style="text-align:center;color:#125784;margin-top:-20px;margin-bottom:22px;font-weight:700;font-size:2rem;">GST Reconciliation Summary</h2>
    <div style="max-width:950px;margin:0 auto">
    <table class="summary-table" style="width:100%;border-collapse:collapse;font-size:1.06em;">
        <thead>
            <tr>
                <th>Sheet Name</th>
                <th>No. of Invoices</th>
                <th>Taxable Amount</th>
                <th>IGST</th>
                <th>CGST</th>
                <th>SGST</th>
                <th>CESS</th>
                <th>Total Tax Amount</th>
            </tr>
        </thead>
        <tbody>
            <tr class="section-header"><td colspan="8">Books Records</td></tr>
    `;

    // Books rows
    booksRows.forEach(row => {
        let tab = row.tab, which = (tab === "MISMATCH" || tab === "MISMATCH_DATE") ? "Books" : null;
        html += `<tr>
            <td style="font-weight:600; text-align:left;">${row.label}</td>
            <td style="text-align:right">${getSummary(tab, "count", which)}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "Taxable_Amount", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "IGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "CGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "SGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "CESS", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "IGST", which) + getSummary(tab, "CGST", which) + getSummary(tab, "SGST", which) + getSummary(tab, "CESS", which))}</td>
        </tr>`;
    });

    // Totals row for Books
    html += `<tr class="totals-row">
        <td style="text-align:left;">Books Records Total</td>
        <td style="text-align:right;font-weight:bold">${getSummary("Books", "count")}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "Taxable_Amount"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "IGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "CGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "SGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "CESS"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Books", "IGST") + getSummary("Books", "CGST") + getSummary("Books", "SGST") + getSummary("Books", "CESS"))}</td>
    </tr>`;

    // Portal section
    html += `<tr class="section-header"><td colspan="8">Portal Records</td></tr>`;

    portalRows.forEach(row => {
        let tab = row.tab, which = (tab === "MISMATCH" || tab === "MISMATCH_DATE") ? "Portal" : null;
        html += `<tr>
            <td style="font-weight:600; text-align:left;">${row.label}</td>
            <td style="text-align:right">${getSummary(tab, "count", which)}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "Taxable_Amount", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "IGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "CGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "SGST", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "CESS", which))}</td>
            <td style="text-align:right">${formatIndianNumber(getSummary(tab, "IGST", which) + getSummary(tab, "CGST", which) + getSummary(tab, "SGST", which) + getSummary(tab, "CESS", which))}</td>
        </tr>`;
    });

    // Totals row for Portal
    html += `<tr class="totals-row">
        <td style="text-align:left;">Portal Records Total</td>
        <td style="text-align:right;font-weight:bold">${getSummary("Portal", "count")}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "Taxable_Amount"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "IGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "CGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "SGST"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "CESS"))}</td>
        <td style="text-align:right;font-weight:bold">${formatIndianNumber(getSummary("Portal", "IGST") + getSummary("Portal", "CGST") + getSummary("Portal", "SGST") + getSummary("Portal", "CESS"))}</td>
    </tr>`;

    html += `</tbody></table>
    <div class="note" style="margin-top:24px">
        <b>Instructions:</b> Each section above summarizes the reconciliation results. Navigate the tabs for detailed records.
    </div>
    </div>`;
    return html;
}

function showTabs() {
    let tabsDiv = document.getElementById('tabs');
    let tabContentsDiv = document.getElementById('tabContents');
    let tabsHtml = '', tabContentsHtml = '', firstActive = '';
    for (let tab of tabOrder) {
        if (tab === "Summary" || resultSheets[tab]) {
            if (!firstActive) firstActive = tab;
            tabsHtml += `<div class="tab${tab === firstActive ? ' active' : ''}" data-tabname="${tab}" onclick="activateTab('${tab}')">${tab === "Summary" ? "Summary" : (tabLabels[tab] || tab)}</div>`;
            let contentHtml = (tab === "Summary") ? generateSummaryHTML() : renderTable(tab, resultSheets[tab]);
            tabContentsHtml += `<div class="tab-content${tab === firstActive ? ' active' : ''}" id="tab-content-${tab}">${contentHtml}</div>`;
        }
    }
    tabsDiv.innerHTML = tabsHtml;
    tabContentsDiv.innerHTML = tabContentsHtml;
    document.getElementById('tabsContainer').style.display = "block";
}
</script>
</body>
</html>